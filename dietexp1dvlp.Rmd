---
title: "Diet Exp1 Development"
output: html_notebook
---
```{r setup}
library("tidyverse")
```


```{r readData}
#Development Data
ddata <- read.csv("Diet1DvlpDataClean.csv")
ddata$Ins2<-as.Date(as.character(ddata$Ins2),format="%d-%b")  # fix the year problem
ddata$Ins3<-as.Date(as.character(ddata$Ins3),format="%d-%b")
ddata$Ins4<-as.Date(as.character(ddata$Ins4),format="%d-%b")
ddata$Ins5<-as.Date(as.character(ddata$Ins5),format="%d-%b")
ddata$HatchDate<-as.Date(as.character(ddata$HatchDate),format="%d-%b")
ddata$PupDate<-as.Date(as.character(ddata$PupDate),format="%d-%b")
ddata$EcloseDate<-as.Date(as.character(ddata$EcloseDate),format="%d-%b")
summary(ddata)

#Morph Data
dietmorph <- read.csv("morphclean.csv")

dietmorph<-left_join(dietmorph, dietmorph %>% select(specimen,wing,area) %>% spread(key=wing,area) %>% 
  transmute(specimen=specimen,fore.area=(LFW+RFW)/2,hind.area=(LHW+RHW)/2, 
            fore.area.asym=LFW-RFW,hind.area.asym=LHW-RHW))

dietmorph<-left_join(dietmorph, dietmorph %>% select(specimen,wing,length) %>% spread(key=wing,length) %>% 
  transmute(specimen=specimen,fore.length=(LFW+RFW)/2,hind.length=(LHW+RHW)/2, 
            fore.length.asym=LFW-RFW,hind.length.asym=LHW-RHW))

dietmorph <- left_join(dietmorph, dietmorph %>% select(specimen,wing,breadth) %>% spread(key=wing,breadth) %>% transmute(specimen=specimen, fore.width=(LFW+RFW)/2, hind.width=(LHW+RHW)/2))

dietmorph<-left_join(dietmorph, dietmorph %>% select(specimen,wing,roundness) %>% spread(key=wing,roundness) %>%
  transmute(specimen=specimen,fore.round=(LFW+RFW)/2))

dietmorph <- left_join(dietmorph, dietmorph %>% select(specimen,wing,asp.ratio) %>% spread(key=wing,asp.ratio) %>% transmute(specimen=specimen, fore.asp.ratio=(LFW+RFW)/2))

dietmorph1 <- subset(dietmorph, wing=="LFW") #gets rid of duplicates
dietmorph2 <- select(dietmorph1, -c(wing, area, length, breadth, roundness, asp.ratio))


#Color Data
dietcolor <- read_csv("DietExp1_ColorClean.csv")
dietcolor1 <- dietcolor[-48,] #this case is missing data

```

```{r create RVs}
ddata.tidy<-gather(ddata, key="stage",value="date",-LarvID,-Diet,-FamLine,-Infection,-Dead,-Sex, -X)
ddata.tidy$stage<-factor(ddata.tidy$stage,levels=c("HatchDate","Ins2", "Ins3","Ins4","Ins5","PupDate","EcloseDate"))
ddata.tidy$stageNum<-as.numeric(ddata.tidy$stage)-1

  
larvae_ids<-unique(ddata.tidy$LarvID)
# for each larva, calculate development rate metrics
overall_DR<-c() #rate
numDaysHatchToEclose<-c() #days
hatchToIns5_DR<-c() #rate
numDaysHatchToIns5<-c() #days
pupation<-c() #days
critical_period<-c() #days
numDaysHatchtoPup <- c() #days
hatch_ins2 <- c()
ins2_ins3 <- c()
ins3_ins4 <- c()
ins4_ins5 <- c()


for(i in 1:length(larvae_ids))
{
  larvaData<-ddata.tidy %>% filter(LarvID==larvae_ids[i])
  # stages per day, all stages from Hatch to Eclose (or last stage reached)
  #overall_DR[i]<- 1/coef(lm(stageNum~date,data=larvaData))[2] 
  
  # days from hatch to eclosure
  numDaysHatchToEclose[i]<-larvaData$date[larvaData$stage=="EcloseDate"]-larvaData$date[larvaData$stage=="HatchDate"]
  
  # stages from Hatch to 5th instar (or last stage reached)
  # hatchToIns5_DR[i]<-1/coef(lm(stageNum~date,data=larvaData %>% filter(stageNum<5)))[2] 
  
  # days from hatching to 5th instar
  numDaysHatchToIns5[i]<-larvaData$date[larvaData$stage=="Ins5"]-larvaData$date[larvaData$stage=="HatchDate"]
  
  #duration of pupation
  pupation[i]<-larvaData$date[larvaData$stage=="EcloseDate"]-larvaData$date[larvaData$stage=="PupDate"]
  
  #Period from 5th instar to pupa
  critical_period[i]<-larvaData$date[larvaData$stage=="PupDate"]-larvaData$date[larvaData$stage=="Ins5"]
  
  #Hatch through pupation
  numDaysHatchtoPup[i] <- larvaData$date[larvaData$stage=="PupDate"]-larvaData$date[larvaData$stage=="HatchDate"]
  
  #Instar moults
  hatch_ins2[i] <- larvaData$date[larvaData$stage=="Ins2"]-larvaData$date[larvaData$stage=="HatchDate"]
  ins2_ins3[i] <- ins2_ins3[i] <- larvaData$date[larvaData$stage=="Ins3"]-larvaData$date[larvaData$stage=="Ins2"]
  ins3_ins4[i] <- ins3_ins4[i] <- larvaData$date[larvaData$stage=="Ins4"]-larvaData$date[larvaData$stage=="Ins3"]
  ins4_ins5[i] <- ins4_ins5[i] <- larvaData$date[larvaData$stage=="Ins5"]-larvaData$date[larvaData$stage=="Ins4"]
  
}

df<-data.frame(LarvID=larvae_ids,numDaysHatchToEclose=numDaysHatchToEclose,numDaysHatchToIns5=numDaysHatchToIns5,hatch_ins2 <-hatch_ins2, ins2_ins3=ins2_ins3, ins3_ins4=ins3_ins4, ins4_ins5=ins4_ins5, critical_period=critical_period, numDaysHatchtoPup=numDaysHatchtoPup)

#put back into original data, remove comments column
ddata<-left_join(ddata,df,by="LarvID")
```

```{r regressing development metrics against predictor variables}

summary(lm(overall_DR~Diet+Sex+Infection,data=ddata))
summary(lm(hatchToIns5_DR~Diet+Sex+Infection,data=ddata))
summary(lm(numDaysHatchToIns5~Diet+Sex+Infection, data=ddata))
summary(lm(pupation~Diet+Sex+Infection,data=ddata))
summary(lm(numDaysHatchToEclose~Diet+Sex+Infection, data=ddata))
summary(lm(critical_period~Diet+Sex+Infection, data=ddata))  #This is where diet is the most significant
summary(lm(numDaysHatchtoPup~Diet+Sex+Infection, data=ddata))

```

```{r Merging data frames for further regressions}

#change column name from 'LarvID' to 'specimen' in 'df' dataframe in order to merge dataframes by specimen
names(ddata)[names(ddata)=="LarvID"] <- "specimen"
names(dietcolor1)[names(dietcolor1)=="Specimen"] <- "specimen"
#Merge dataframes -- morph and color with development rate
totaldata <- merge(dietmorph2,dietcolor1, by="specimen")
totaldata1 <- merge(totaldata,ddata, by="specimen")

#Removing duplicate or unnecessary columns
totaldata1$Diet.x <- NULL
totaldata1$Diet.y <- NULL
totaldata1$Sex.x <- NULL
totaldata1$Sex.y <- NULL
totaldata1$FamLine <- NULL
totaldata1$Famline <- NULL
totaldata1$Infection.x <- NULL
totaldata1$Infection.y <- NULL
totaldata1$X <- NULL
totaldata1$Dead <- NULL


#This file contains all relevant morphological, pigmentation, and development data
```

```{r average development plots} 

#Individual development rates
ggplot(data=ddata.tidy %>% filter(LarvID==17),aes(x=date,y=stage))+geom_point()+geom_smooth(aes(y=as.numeric(stage)),method="lm",se=FALSE) 

#Average development rates
#plot <- ggplot(data=ddata.tidy,aes(x=date,y=stage,group=Diet,color=factor(Diet),fill=factor(Diet)))+
 # geom_smooth(aes(y=stage),se=TRUE) 

plot1 <- ggplot(data=ddata.tidy %>% filter(stage == "Ins5" | stage== "PupDate"),aes(x=date,y=stage,group=Diet,color=factor(Diet),fill=factor(Diet)))+
  geom_smooth(aes(y=stage),method="lm",se=TRUE) 
plot1

total_dvlpmtplot <- ggplot(ddata.tidy %>% filter(stage == "HatchDate" | stage=="PupDate"), aes(x=date,y=stage,group=Diet,color=factor(Diet), fill=factor(Diet))) +
  geom_smooth(aes(y=stage), method="lm", se=TRUE)
total_dvlpmtplot

# stacked bar charts
total_dvlmpt_bar<- ggplot(ddata.tidy, aes(x=Diet,y=date,fill=stage)) +
  geom_bar(position="fill", stat="identity") 

means <- ddata.tidy %>%
  mutate(stage=factor(stage, levels=c("HatchDate", "Ins2", "Ins3", "Ins4", "Ins5", "PupDate", "EcloseDate"))) %>%
  group_by(stage) %>%
  summarise(mean=mean(date))

testbar <- ggplot(ddata.tidy) +
  geom_bar(aes(x=Diet, y=date, group=Diet, fill=mean), stat="identity") 
  #scale_y_date(ddata.tidy$date, date_labels="%d/%b")
  

#####################
hatch_ins2plot <- ggplot(ddata.tidy %>% filter(stage == "HatchDate" | stage=="Ins2"), aes(x=date,y=stage,group=Diet,color=factor(Diet), fill=factor(Diet))) +
  geom_smooth(aes(y=stage), method="lm", se=TRUE)
print(hatch_ins2plot)

ins2_ins3plot <- ggplot(ddata.tidy %>% filter(stage == "Ins2" | stage=="Ins3"), aes(x=date,y=stage,group=Diet,color=factor(Diet), fill=factor(Diet))) +
  geom_smooth(aes(y=stage), method="lm", se=TRUE)
print(ins2_ins3plot)

ins3_ins4plot <- ggplot(ddata.tidy %>% filter(stage == "Ins3" | stage=="Ins4"), aes(x=date,y=stage,group=Diet,color=factor(Diet), fill=factor(Diet))) +
  geom_smooth(aes(y=stage), method="lm", se=TRUE)
print(ins3_ins4plot)

ins4_ins5plot <- ggplot(ddata.tidy %>% filter(stage == "Ins4" | stage=="Ins5"), aes(x=date,y=stage,group=Diet,color=factor(Diet), fill=factor(Diet))) +
  geom_smooth(aes(y=stage), method="lm", se=TRUE)
print(ins4_ins5plot)

str(ddata.tidy)



 


```

```{r development rate regression plots}


#Plots for host plant species v. overall development rate/days to development
overall_DR.plot <- ggboxplot(ddata, x="Diet", y="overall_DR", fill="lightblue") +
labs(y="Overall Development Rate", x = "Host Plant Species") + 
ggtitle("Effects of host plant species on development rate") +
theme_minimal() +
scale_x_discrete(labels=c("N"="Native", "T"="Tropical")) +
stat_compare_means(method="anova")
print(overall_DR.plot)

overall_days.plot <- ggboxplot(ddata, x="Diet", y="numDaysHatchToEclose", fill="lightblue") +
labs(y="Number of Days", x = "Host Plant Species") + 
ggtitle("Effects of host plant species on development rate") +
theme_minimal() +
scale_x_discrete(labels=c("N"="Native", "T"="Tropical")) +
stat_compare_means(method="anova")
print(overall_days.plot)
 

```

```{r development/morph regressions}

#USE TOTALDATA1 DATA FILE
d1 <- gls(fore.area~overall_DR, data=totaldata1)
d1aov <- aov(d1, type="marginal", data=totaldata1)
anova(d1aov)

d1plot <- ggplot(totaldata1, aes(x=overall_DR, y=fore.area)) +
  geom_smooth(method="lm") 
print(d1plot)

d2 <- gls(hind.area~overall_DR, data=totaldata1)
d2aov <- aov(d2, type="marginal", data=totaldata1)
anova(d2aov)

d2plot <-ggplot(totaldata1, aes(x=overall_DR, y=hind.area)) +
  geom_smooth(method="lm") 
print(d2plot)


```

